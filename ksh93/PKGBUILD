# TODO: Add patches from the gisburn repo (Such as the ksh93 config), red hat, and debian.
#
#
#
pkgname=ksh93
pkgver=1.0.10
pkgrel=1
pkgdesc="The Original ATT Korn Shell, Now Maintained By The Community."
arch=('x86_64')
url="https://www.github.com/ksh93/ksh"
license=('spdx:EPL-2.0')
# Dpeneds (Add Later)
makedepends=(
	'gcc'
) #Need to update later.
# optdepends
source=("${pkgname}-${pkgver}.zip"::https://github.com/ksh93/ksh/archive/refs/tags/v1.0.10.zip)
sha256sums=('ab412118ce9527c6d805335080593fa874a0b859e9229c172f3fcf55d26f92e9')

# This is necessary
export PATH="/bin:/usr/bin:$gccdir:$gccdir/include:/usr/include"

# Things might get a bit messary, prepare yourselves.
# I really should use gisburn's kshrc default config.
build() {
	cd "${srcdir}/ksh-${pkgver}"
	
	export CYGWIN_CHOST="${CHOST/-msys/-cygwin}"

	# Do not, I repeat, DO NOT delete the src subdir.
	# For now, multiple rounds must be done.

	# Bit of a workaround with cc1.exe not found for some reason.
	export gccdir="/usr/lib/gcc/x86_64-pc-msys/13.3.0"
	export PATH="/bin:/usr/bin:$gccdir:$gccdir/include:/usr/include"

	# Additional weird workaround.
	export CFLAGS="-I/usr/lib/gcc/x86_64-pc-msys/13.3.0/include"
	export CFLAGS="$CFLAGS -L/usr/lib/gcc/x86_64-pc-msys/13.3.0"
	export CCFLAGS="${CFLAGS} -fno-use-linker-plugin"
	export LIBRARY_PATH="/usr/lib/gcc/x86_64-pc-msys/13.3.0"

	export PATH="$PATH:$PWD/arch/msys.i386/lib/probe/C/make"

	# What the inane build system does by default is
	# entirely a shell script system. It sets 'chmod +x' to the script
	# but that does nothing with windows. Need to append
	# shebang at the start.
	sed -i '1s/^/#!\/usr\/bin\/bash\n/' src/cmd/INIT/mamprobe.sh

	# It WILL fail during the first round. It MUST be ran twice.
	printf "This WILL show an error at some point. This is to be expected.\n"
	printf "The build command is ran twice because of fork() issue.\n"
	printf "\n\nRound 1 begins now.\n\n"
	sleep 2

	CC="/usr/bin/gcc" /usr/bin/bash bin/package make PACKAGEROOT="$PWD" || true

	printf "\n\nSecond and final round begins now.\n\n"
	sleep 2
	CC="/usr/bin/gcc" /usr/bin/bash bin/package make PACKAGEROOT="$PWD" || true

	sleep 2
	printf "\n\nFinished!\n\n"
	sleep 2


}

package() {
	cd "${srcdir}"
	install -dm0755 "${pkgdir}/etc/skel"
	install -dm0755 "${pkgdir}/usr/share/ksh"
	install -dm0755 "${pkgdir}/usr/share/doc/ksh"
	install -dm0755 "${pkgdir}/usr/share/licenses/ksh"

	# Install the core components of ksh93
	cd "${srcdir}/ksh-${pkgver}"
	CC="/usr/bin/gcc" /usr/bin/bash bin/package install "${pkgdir}/usr" PACKAGEROOT="$PWD"

	# install ksh sample rc file

	# Install copyright and license files
	# Other stuff
}
