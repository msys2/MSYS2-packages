# Maintainer: Maksim Bondarenkov <maksapple2306@gmail.com>

pkgname=cargo-edit
pkgver=0.13.7
pkgrel=1
pkgdesc="A utility for managing cargo dependencies from the command line"
arch=('x86_64')
url='https://github.com/killercup/cargo-edit'
msys2_changelog_url='https://github.com/killercup/cargo-edit/blob/master/CHANGELOG.md'
msys2_references=(
  'archlinux: cargo-edit'
  'purl: pkg:cargo/cargo-edit'
)
license=('spdx:MIT')
depends=("rust")
source=("${url}/archive/v${pkgver}/${pkgname}-${pkgver}.tar.gz"
        "ring-0.17.14.tar.gz::https://crates.io/api/v1/crates/ring/0.17.14/download"
        "ring-support-cygwin.patch")
sha256sums=('f242010b4b0b8ccd245693858d26a35f70bef572a209f4977d192c1215e861c6'
            'a4689e6c2294d81e88dc6261c768b63bc4fcdb852be6d1352498b114f61383b7'
            '8595d93ebdcc37b023113b60196ba0d4bec2d9623e4092b19a699ed1458f33fa')

prepare() {
  cd "${pkgname}-${pkgver}"

  patch -p1 -d ../ring-0.17.14 -i ../ring-support-cygwin.patch
  cat >> Cargo.toml <<END

[patch.crates-io]
ring.path = "../ring-0.17.14"
END

  cargo update -p mio@1.0.4 --precise 1.1.0
  cargo fetch --locked --target "${RUST_CHOST}"
}

build() {
  cd "${pkgname}-${pkgver}"

  cargo build --release --frozen
}

check() {
  cd "${pkgname}-${pkgver}"

  cargo test --release --frozen
}

package() {
  cd "${pkgname}-${pkgver}"

  cargo install \
    --offline \
    --no-track \
    --frozen \
    --path . \
    --root "${pkgdir}/usr"

  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
