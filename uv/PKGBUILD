# Maintainer: Christoph Reiter <reiter.christoph@gmail.com>

_realname=uv
pkgbase=${_realname}
pkgname=("python-${_realname}-build")
pkgver=0.9.28
pkgrel=1
pkgdesc='An extremely fast Python package installer and resolver, written in Rust (python build backend)'
arch=('x86_64')
url="https://github.com/astral-sh/uv"
license=('spdx:Apache-2.0 OR MIT')
makedepends=('rust'
             'python-maturin'
             'python-installer'
             'liblzma-devel'
             'libzstd-devel'
             'pkgconf'
             'git')
options=('!strip')
source=("git+${url}.git#tag=${pkgver}"
        "zstd-sys.tar.gz::https://crates.io/api/v1/crates/zstd-sys/2.0.15+zstd.1.5.7/download"
        "link-zstd-dynamically.patch")
sha256sums=('8395ac002de1d03a06b406b783ec7f958d3312e338f20db4849c70c9cd8ab987'
            'eb81183ddd97d0c74cedf1d50d85c8d08c1b8b68ee863bdee9e706eedba1a237'
            '48f4900ceb02d3aaf9a1020f33d56629156e96759f456c0e7ca18bfcf910767b')

prepare() {
  cd "${_realname}"

  patch -d "../zstd-sys-2.0.15+zstd.1.5.7" -i "../link-zstd-dynamically.patch"
  cat >> Cargo.toml <<END

[patch.crates-io]
zstd-sys.path = "../zstd-sys-2.0.15+zstd.1.5.7"
END

  rm rust-toolchain.toml
  cargo update -p zstd-sys
  cargo fetch --locked
}

build() {
  cd "${_realname}"

  export PKG_CONFIG_ALL_DYNAMIC=1
  export ZSTD_SYS_USE_PKG_CONFIG=1
  maturin build --frozen --strip --release --all-features -m crates/uv-build/Cargo.toml
}

package() {
  depends=('python' 'liblzma' 'libzstd')

  cd "${_realname}"

  python -m installer --prefix=/usr \
    --destdir="${pkgdir}" target/wheels/uv_build-$pkgver-*.whl

  install -Dm644 LICENSE-MIT -t "${pkgdir}/usr/share/licenses/${pkgname}/"
  install -Dm644 LICENSE-APACHE -t "${pkgdir}/usr/share/licenses/${pkgname}/"
}
